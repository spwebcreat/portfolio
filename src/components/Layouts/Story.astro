---
// Story セクション — FV と About の間のスクロール連動テキスト
---

<section class="story" id="story">
  <div class="story-inner">
    <h2 class="story-heading" data-story="heading">
      Build Your Digital Castle.
    </h2>

    <div class="story-block" data-story-index="0">
      <p>コードは、ただの文字列じゃない。</p>
      <p>設計図であり、構造体であり、</p>
      <p>誰かの「こうしたい」を形にする素材。</p>
    </div>

    <div class="story-block" data-story-index="1">
      <p>美しい城には、見えない土台がある。</p>
      <p>堅牢な基盤、緻密な設計、細部への執念。</p>
      <p>それはWebサイトも同じだと思っている。</p>
    </div>

    <div class="story-block" data-story-index="2">
      <p>約15年、数えきれないサイトを手がけてきた。</p>
      <p>デザインもコードも、自分の手で。</p>
      <p>その一つひとつが、今の土台になっている。</p>
    </div>

    <div class="story-block" data-story-index="3">
      <p>AIが当たり前になった時代。</p>
      <p>素材は増えた。できることも広がった。</p>
      <p>でも、城を設計するのは、人だ。</p>
    </div>

    <div class="story-block" data-story-index="4">
      <p>どの素材を選び、どう組み、何を届けるか。</p>
      <p>その判断ができるのは、積み上げてきた者だけだと思う。</p>
    </div>

    <div class="story-block" data-story-index="5">
      <p>経験と技術、そして新しい力を携えて。</p>
      <p>次の城を、描きにいく。</p>
    </div>
  </div>
</section>

<script>
  function initStoryScroll() {
    const story = document.getElementById('story');
    if (!story) return;

    const blocks = story.querySelectorAll<HTMLElement>('.story-block');
    const heading = story.querySelector<HTMLElement>('.story-heading');

    // 各ブロックの表示区間（Story内進捗 0〜1）
    const BLOCK_TIMINGS = [
      { start: 0.00, peak: 0.03, end: 0.10 },  // heading
      { start: 0.14, peak: 0.19, end: 0.27 },  // block 0
      { start: 0.26, peak: 0.31, end: 0.39 },  // block 1
      { start: 0.38, peak: 0.43, end: 0.51 },  // block 2
      { start: 0.50, peak: 0.55, end: 0.63 },  // block 3
      { start: 0.62, peak: 0.67, end: 0.76 },  // block 4
      { start: 0.75, peak: 0.81, end: 0.95 },  // block 5（最後は長め）
    ];

    let ticking = false;

    function onScroll() {
      if (ticking) return;
      ticking = true;

      requestAnimationFrame(() => {
        const rect = story!.getBoundingClientRect();
        const storyHeight = story!.offsetHeight - window.innerHeight;
        const scrolled = -rect.top;
        const progress = Math.max(0, Math.min(1, scrolled / storyHeight));

        // heading の opacity
        if (heading) {
          const ht = BLOCK_TIMINGS[0];
          const headingOpacity = progress < ht.start ? 0
            : progress < ht.peak ? (progress - ht.start) / (ht.peak - ht.start)
            : progress < ht.end ? 1
            : Math.max(0, 1 - (progress - ht.end) / 0.1);
          heading.style.opacity = String(headingOpacity);
          heading.style.transform = `translateY(${(1 - headingOpacity) * 15}px)`;
        }

        // 各ブロックの opacity と transform
        let activeBlock = -1;
        blocks.forEach((block, i) => {
          const bt = BLOCK_TIMINGS[i + 1]; // +1 because [0] is heading
          let opacity = 0;
          if (progress >= bt.start && progress <= bt.end) {
            if (progress < bt.peak) {
              opacity = (progress - bt.start) / (bt.peak - bt.start);
            } else {
              opacity = 1 - Math.max(0, (progress - bt.end + 0.05) / 0.05);
              opacity = Math.max(0, Math.min(1, opacity));
            }
            activeBlock = i;
          }
          block.style.opacity = String(opacity);
          block.style.transform = `translateY(${(1 - opacity) * 20}px)`;
        });

        // ThreeModel に進捗を通知
        window.dispatchEvent(new CustomEvent('story:progress', {
          detail: { progress, activeBlock }
        }));

        ticking = false;
      });
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll(); // 初期状態
  }

  // DOM Ready 後に初期化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initStoryScroll);
  } else {
    initStoryScroll();
  }
</script>

<style>
  .story {
    position: relative;
    z-index: 10;
    height: 420vh;
    pointer-events: none;
  }

  .story-inner {
    position: sticky;
    top: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 0 1.5rem;
  }

  .story-heading {
    font-family: 'Montserrat', sans-serif;
    font-weight: 800;
    font-size: clamp(1.5rem, 4vw, 2.8rem);
    color: #FDFDFD;
    margin-bottom: 2.5rem;
    opacity: 0;
    transition: none;
    text-shadow: 0 0 40px rgba(0, 229, 255, 0.25);
    letter-spacing: 0.02em;
    position: relative;
    z-index: 1;
  }

  .story-block {
    position: absolute;
    top: 50%;
    left: 50%;
    translate: -50% -50%;
    max-width: 540px;
    width: 100%;
    opacity: 0;
    padding: 1.5rem 2rem;
  }

  .story-block::before {
    content: '';
    position: absolute;
    inset: -10px -30px;
    background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.5) 0%, transparent 70%);
    border-radius: 20px;
    z-index: -1;
    pointer-events: none;
  }

  .story-block p {
    font-size: clamp(0.85rem, 1.4vw, 1.05rem);
    line-height: 2.2;
    color: rgba(253, 253, 253, 0.92);
    letter-spacing: 0.06em;
    margin: 0;
  }

  @media (max-width: 768px) {
    .story {
      height: 480vh;
    }
    .story-block {
      max-width: 90vw;
      padding: 1rem 1.2rem;
    }
    .story-block::before {
      background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.6) 0%, transparent 75%);
    }
  }
</style>
