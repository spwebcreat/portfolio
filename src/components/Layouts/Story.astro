---
// Story セクション — FV と About の間のスクロール連動テキスト
---

<section class="story" id="story">
  <div class="story-inner">
    <h2 class="story-heading" data-story="heading">
      Build Your Digital Castle.
    </h2>

    <div class="story-block" data-story-index="0">
      <p>コードは、ただの文字列じゃない。</p>
      <p>設計図であり、構造体であり、</p>
      <p>誰かの「こうしたい」を形にする素材。</p>
    </div>

    <div class="story-block" data-story-index="1">
      <p>美しい城には、見えない土台がある。</p>
      <p>堅牢な基盤、緻密な設計、細部への執念。</p>
      <p>それはWebサイトも同じだと思っている。</p>
    </div>

    <div class="story-block" data-story-index="2">
      <p>約15年、数えきれないサイトを手がけてきた。</p>
      <p>デザインもコードも、自分の手で。</p>
      <p>その一つひとつが、今の土台になっている。</p>
    </div>

    <div class="story-block" data-story-index="3">
      <p>AIが当たり前になった時代。</p>
      <p>素材は増えた。できることも広がった。</p>
      <p>でも、城を設計するのは、人だ。</p>
    </div>

    <div class="story-block" data-story-index="4">
      <p>どの素材を選び、どう組み、<br>何を届けるか。</p>
      <p>その判断ができるのは、<br>積み上げてきた者だけだと思う。</p>
    </div>

    <div class="story-block" data-story-index="5">
      <p>経験と技術、そして新しい力を携えて。</p>
      <p>次の城を、創造しにいく。</p>
    </div>

    <div class="story-bottom-nav">
      <button class="story-bottom-prev" aria-label="Previous" type="button" disabled>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        <span>Prev</span>
      </button>
      <button class="story-bottom-next" aria-label="Next" type="button">
        <span>Next</span>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 6 15 12 9 18"></polyline></svg>
      </button>
    </div>

    <div class="story-scroll-cta">
      <span>Scroll</span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
    </div>

    <nav class="story-nav" aria-label="Story navigation">
      <button class="story-nav-arrow story-nav-prev" aria-label="Previous" type="button" disabled>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
      </button>
      <div class="story-nav-dots">
        <button class="story-nav-dot is-active" data-nav-index="0" aria-label="Go to heading" type="button"></button>
        <button class="story-nav-dot" data-nav-index="1" aria-label="Go to block 1" type="button"></button>
        <button class="story-nav-dot" data-nav-index="2" aria-label="Go to block 2" type="button"></button>
        <button class="story-nav-dot" data-nav-index="3" aria-label="Go to block 3" type="button"></button>
        <button class="story-nav-dot" data-nav-index="4" aria-label="Go to block 4" type="button"></button>
        <button class="story-nav-dot" data-nav-index="5" aria-label="Go to block 5" type="button"></button>
        <button class="story-nav-dot" data-nav-index="6" aria-label="Go to block 6" type="button"></button>
      </div>
      <button class="story-nav-arrow story-nav-next" aria-label="Next" type="button">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
      </button>
    </nav>
  </div>
</section>

<script>
  function initStoryScroll() {
    const story = document.getElementById('story');
    if (!story) return;

    const blocks = story.querySelectorAll<HTMLElement>('.story-block');
    const heading = story.querySelector<HTMLElement>('.story-heading');

    // 各ブロックの表示区間（Story内進捗 0〜1）
    const BLOCK_TIMINGS = [
      { start: 0.00, peak: 0.03, end: 0.10 },  // heading
      { start: 0.14, peak: 0.19, end: 0.27 },  // block 0
      { start: 0.26, peak: 0.31, end: 0.39 },  // block 1
      { start: 0.38, peak: 0.43, end: 0.51 },  // block 2
      { start: 0.50, peak: 0.55, end: 0.63 },  // block 3
      { start: 0.62, peak: 0.67, end: 0.76 },  // block 4
      { start: 0.75, peak: 0.81, end: 0.95 },  // block 5（最後は長め）
    ];

    // --- Navigation elements ---
    const nav = story.querySelector<HTMLElement>('.story-nav');
    const prevBtn = story.querySelector<HTMLButtonElement>('.story-nav-prev');
    const nextBtn = story.querySelector<HTMLButtonElement>('.story-nav-next');
    const dots = story.querySelectorAll<HTMLButtonElement>('.story-nav-dot');
    const bottomNav = story.querySelector<HTMLElement>('.story-bottom-nav');
    const bottomPrev = story.querySelector<HTMLButtonElement>('.story-bottom-prev');
    const bottomNext = story.querySelector<HTMLButtonElement>('.story-bottom-next');
    const scrollCta = story.querySelector<HTMLElement>('.story-scroll-cta');
    let currentNavIndex = 0;

    function scrollToBlock(index: number) {
      const clamped = Math.max(0, Math.min(BLOCK_TIMINGS.length - 1, index));
      const storyTop = story!.offsetTop;
      const storyHeight = story!.offsetHeight - window.innerHeight;
      const targetScroll = storyTop + storyHeight * BLOCK_TIMINGS[clamped].peak;
      window.scrollTo({ top: targetScroll, behavior: 'smooth' });
    }

    function updateNavState(activeIndex: number) {
      currentNavIndex = activeIndex;
      dots.forEach((dot, i) => {
        dot.classList.toggle('is-active', i === activeIndex);
      });
      if (prevBtn) prevBtn.disabled = activeIndex <= 0;
      if (nextBtn) nextBtn.disabled = activeIndex >= BLOCK_TIMINGS.length - 1;
      if (bottomPrev) bottomPrev.disabled = activeIndex <= 0;
      if (bottomNext) bottomNext.disabled = activeIndex >= BLOCK_TIMINGS.length - 1;
    }

    // Click handlers
    prevBtn?.addEventListener('click', () => scrollToBlock(currentNavIndex - 1));
    nextBtn?.addEventListener('click', () => scrollToBlock(currentNavIndex + 1));
    bottomPrev?.addEventListener('click', () => scrollToBlock(currentNavIndex - 1));
    bottomNext?.addEventListener('click', () => scrollToBlock(currentNavIndex + 1));
    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const idx = Number(dot.dataset.navIndex);
        scrollToBlock(idx);
      });
    });

    let ticking = false;

    function onScroll() {
      if (ticking) return;
      ticking = true;

      requestAnimationFrame(() => {
        const rect = story!.getBoundingClientRect();
        const storyHeight = story!.offsetHeight - window.innerHeight;
        const scrolled = -rect.top;
        const progress = Math.max(0, Math.min(1, scrolled / storyHeight));

        // heading の opacity
        if (heading) {
          const ht = BLOCK_TIMINGS[0];
          const headingOpacity = progress < ht.end ? 1
            : Math.max(0, 1 - (progress - ht.end) / 0.1);
          heading.style.opacity = String(headingOpacity);
          heading.style.transform = `translateY(${(1 - headingOpacity) * 15}px)`;
        }

        // 各ブロックの opacity と transform
        let activeBlock = -1;
        blocks.forEach((block, i) => {
          const bt = BLOCK_TIMINGS[i + 1]; // +1 because [0] is heading
          let opacity = 0;
          if (progress >= bt.start && progress <= bt.end) {
            if (progress < bt.peak) {
              opacity = (progress - bt.start) / (bt.peak - bt.start);
            } else {
              opacity = 1 - Math.max(0, (progress - bt.end + 0.05) / 0.05);
              opacity = Math.max(0, Math.min(1, opacity));
            }
            activeBlock = i;
          }
          block.style.opacity = String(opacity);
          block.style.transform = `translateY(${(1 - opacity) * 20}px)`;
        });

        // ThreeModel に進捗を通知
        window.dispatchEvent(new CustomEvent('story:progress', {
          detail: { progress, activeBlock }
        }));

        // --- Navigation visibility & active dot ---
        const isVisible = progress > 0 && progress < 1;
        const lastTiming = BLOCK_TIMINGS[BLOCK_TIMINGS.length - 1];
        const isLastBlock = progress >= lastTiming.start && progress < 1;
        if (nav) {
          nav.classList.toggle('is-visible', isVisible);
        }
        if (bottomNav) {
          bottomNav.classList.toggle('is-visible', isVisible && !isLastBlock);
        }
        if (scrollCta) {
          scrollCta.classList.toggle('is-visible', isLastBlock);
        }

        // Find closest block by peak proximity
        let closestIndex = 0;
        let closestDist = Infinity;
        BLOCK_TIMINGS.forEach((bt, i) => {
          const dist = Math.abs(progress - bt.peak);
          if (dist < closestDist) {
            closestDist = dist;
            closestIndex = i;
          }
        });
        updateNavState(closestIndex);

        ticking = false;
      });
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll(); // 初期状態
  }

  // DOM Ready 後に初期化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initStoryScroll);
  } else {
    initStoryScroll();
  }
</script>

<style>
  .story {
    position: relative;
    z-index: 10;
    height: 420vh;
    @media (min-width: 768px) {
      pointer-events: none;
    }
  }

  .story-inner {
    position: sticky;
    top: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 0 1.5rem;
    @media (max-width: 768px) {
      pointer-events: none;
    }
  }

  .story-heading {
    font-family: 'Montserrat', sans-serif;
    font-weight: 800;
    font-size: clamp(1.5rem, 4vw, 2.8rem);
    color: #FDFDFD;
    margin-bottom: 2.5rem;
    opacity: 1;
    transition: none;
    text-shadow: 0 0 40px rgba(0, 229, 255, 0.25);
    letter-spacing: 0.02em;
    position: relative;
    z-index: 1;
  }

  .story-block {
    position: absolute;
    top: 50%;
    left: 50%;
    translate: -50% -50%;
    max-width: 540px;
    width: 100%;
    opacity: 0;
    padding: 1.5rem 2rem;
  }

  .story-block::before {
    content: '';
    position: absolute;
    inset: -10px -30px;
    background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.5) 0%, transparent 70%);
    border-radius: 20px;
    z-index: -1;
    pointer-events: none;
  }

  .story-block p {
    font-size: clamp(0.85rem, 1.4vw, 1.05rem);
    line-height: 2.2;
    color: rgba(253, 253, 253, 0.92);
    letter-spacing: 0.06em;
    margin: 0;
  }

  /* --- Story Navigation --- */
  .story-nav {
    position: fixed;
    right: 1.5rem;
    top: 50%;
    translate: 0 -50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    z-index: 20;
    pointer-events: auto;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .story-nav.is-visible {
    opacity: 1;
  }

  .story-nav-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid rgba(0, 229, 255, 0.25);
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(4px);
    color: rgba(253, 253, 253, 0.7);
    cursor: pointer;
    transition: color 0.25s, border-color 0.25s, box-shadow 0.25s;
  }

  .story-nav-arrow:hover:not(:disabled) {
    color: #00e5ff;
    border-color: rgba(0, 229, 255, 0.5);
    box-shadow: 0 0 12px rgba(0, 229, 255, 0.15);
  }

  .story-nav-arrow:disabled {
    opacity: 0.25;
    cursor: default;
  }

  .story-nav-dots {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0;
  }

  .story-nav-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: 1px solid rgba(0, 229, 255, 0.3);
    background: rgba(253, 253, 253, 0.15);
    cursor: pointer;
    transition: background 0.25s, border-color 0.25s, box-shadow 0.25s, transform 0.25s;
    padding: 0;
  }

  .story-nav-dot:hover {
    background: rgba(0, 229, 255, 0.3);
    border-color: rgba(0, 229, 255, 0.5);
  }

  .story-nav-dot.is-active {
    background: #00e5ff;
    border-color: #00e5ff;
    box-shadow: 0 0 8px rgba(0, 229, 255, 0.4);
    transform: scale(1.3);
  }

  /* --- Bottom arrow nav --- */
  .story-bottom-nav {
    position: absolute;
    top: calc(50% + 5rem);
    left: 50%;
    translate: -50% 0;
    display: flex;
    align-items: center;
    gap: 2rem;
    z-index: 20;
    pointer-events: auto;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .story-bottom-nav.is-visible {
    opacity: 1;
  }

  .story-bottom-nav button {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    border: none;
    background: none;
    color: rgba(253, 253, 253, 0.5);
    cursor: pointer;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    transition: color 0.25s;
    padding: 0.4rem 0;
  }

  .story-bottom-nav button:hover:not(:disabled) {
    color: rgba(253, 253, 253, 0.85);
  }

  .story-bottom-nav button:disabled {
    opacity: 0.2;
    cursor: default;
  }

  /* --- Scroll CTA (last block) --- */
  .story-scroll-cta {
    position: absolute;
    top: calc(50% + 5rem);
    left: 50%;
    translate: -50% 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    z-index: 20;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s ease;
    color: rgba(253, 253, 253, 0.45);
    font-family: 'Montserrat', sans-serif;
    font-size: 0.8rem;
    font-weight: 500;
    letter-spacing: 0.1em;
  }

  .story-scroll-cta.is-visible {
    opacity: 1;
  }

  .story-scroll-cta svg {
    animation: story-bounce 1.8s ease-in-out infinite;
  }

  @keyframes story-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(4px); }
  }

  @media (max-width: 768px) {
    .story {
      height: 480vh;
    }
    .story-block {
      max-width: 90vw;
      padding: 1rem 1.2rem;
    }
    .story-block::before {
      background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.6) 0%, transparent 75%);
    }
    .story-nav {
      right: 0.75rem;
    }
    .story-nav-arrow {
      width: 30px;
      height: 30px;
    }
    .story-nav-arrow svg {
      width: 14px;
      height: 14px;
    }
    .story-nav-dot {
      width: 7px;
      height: 7px;
    }
    .story-bottom-nav {
      top: calc(50% + 4rem);
      gap: 1.5rem;
    }
    .story-bottom-nav button {
      font-size: 0.78rem;
    }
    .story-bottom-nav button svg {
      width: 12px;
      height: 12px;
    }
    .story-scroll-cta {
      top: calc(50% + 4rem);
      font-size: 0.75rem;
    }
  }
</style>
